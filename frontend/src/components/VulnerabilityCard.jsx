import { useState } from "react";
// eslint-disable-next-line no-unused-vars
import { motion } from "framer-motion";
import { ChevronDownIcon, ChevronUpIcon } from "@heroicons/react/24/outline";

const VulnerabilityCard = ({ vulnerability, type = "sonarqube" }) => {
  const [expanded, setExpanded] = useState(false);

  const getSeverityColor = (severity) => {
    const colors = {
      CRITICAL: "bg-red-500/20 text-red-400 border-red-500/50",
      HIGH: "bg-orange-500/20 text-orange-400 border-orange-500/50",
      MEDIUM: "bg-yellow-500/20 text-yellow-400 border-yellow-500/50",
      LOW: "bg-blue-500/20 text-blue-400 border-blue-500/50",
      Critical: "bg-red-500/20 text-red-400 border-red-500/50",
      High: "bg-orange-500/20 text-orange-400 border-orange-500/50",
      Medium: "bg-yellow-500/20 text-yellow-400 border-yellow-500/50",
      Low: "bg-blue-500/20 text-blue-400 border-blue-500/50",
    };
    return (
      colors[severity] || "bg-gray-500/20 text-gray-400 border-gray-500/50"
    );
  };

  const getTitle = () => {
    if (type === "sonarqube") {
      return vulnerability.message || vulnerability.rule || "Issue";
    } else if (type === "zap") {
      return vulnerability.name || "Alert";
    } else if (type === "trivy") {
      return (
        vulnerability.title || vulnerability.vulnerability_id || "Vulnerability"
      );
    }
    return "Vulnerability";
  };

  const getDescription = () => {
    if (type === "sonarqube") {
      return vulnerability.rule_description || vulnerability.message;
    } else if (type === "zap") {
      return vulnerability.description;
    } else if (type === "trivy") {
      return vulnerability.description;
    }
    return "";
  };

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      className="card border-l-4"
      style={{
        borderLeftColor:
          vulnerability.severity === "CRITICAL" ||
          vulnerability.severity === "Critical"
            ? "#EF4444"
            : vulnerability.severity === "HIGH" ||
                vulnerability.severity === "High"
              ? "#F97316"
              : "#EAB308",
      }}
    >
      <div className="flex items-start justify-between">
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-2">
            <span
              className={`px-2 py-1 rounded text-xs font-medium border ${getSeverityColor(vulnerability.severity || vulnerability.risk)}`}
            >
              {vulnerability.severity || vulnerability.risk || "Unknown"}
            </span>
            {type === "sonarqube" && vulnerability.component && (
              <span className="text-xs text-gray-400">
                {vulnerability.component.split(":").pop()}
                {vulnerability.line && `:${vulnerability.line}`}
              </span>
            )}
            {type === "zap" && vulnerability.url && (
              <span className="text-xs text-gray-400 truncate max-w-xs">
                {vulnerability.url}
              </span>
            )}
            {type === "trivy" && vulnerability.pkg_name && (
              <span className="text-xs text-gray-400">
                {vulnerability.pkg_name}
              </span>
            )}
          </div>
          <h4 className="text-white font-semibold mb-1">{getTitle()}</h4>
          {getDescription() && (
            <p className="text-gray-300 text-sm line-clamp-2">
              {getDescription()}
            </p>
          )}
        </div>
        <button
          onClick={() => setExpanded(!expanded)}
          className="ml-4 text-gray-400 hover:text-white"
        >
          {expanded ? (
            <ChevronUpIcon className="w-5 h-5" />
          ) : (
            <ChevronDownIcon className="w-5 h-5" />
          )}
        </button>
      </div>

      {expanded && (
        <motion.div
          initial={{ opacity: 0, height: 0 }}
          animate={{ opacity: 1, height: "auto" }}
          className="mt-4 pt-4 border-t border-gray-700 space-y-2"
        >
          {type === "sonarqube" && (
            <>
              {vulnerability.rule_name && (
                <div>
                  <strong className="text-cyber-blue">Rule:</strong>{" "}
                  {vulnerability.rule_name}
                </div>
              )}
              {vulnerability.effort && (
                <div>
                  <strong className="text-cyber-blue">Effort:</strong>{" "}
                  {vulnerability.effort}
                </div>
              )}
              {vulnerability.tags && vulnerability.tags.length > 0 && (
                <div>
                  <strong className="text-cyber-blue">Tags:</strong>{" "}
                  {vulnerability.tags.map((tag) => (
                    <span
                      key={tag}
                      className="px-2 py-1 bg-gray-700 rounded text-xs mr-1"
                    >
                      {tag}
                    </span>
                  ))}
                </div>
              )}
            </>
          )}
          {type === "zap" && (
            <>
              {vulnerability.solution && (
                <div>
                  <strong className="text-cyber-blue">Solution:</strong>
                  <p className="text-gray-300 mt-1">{vulnerability.solution}</p>
                </div>
              )}
              {vulnerability.attack && (
                <div>
                  <strong className="text-cyber-blue">Attack Vector:</strong>
                  <code className="block mt-1 p-2 bg-gray-800 rounded text-sm">
                    {vulnerability.attack}
                  </code>
                </div>
              )}
              {vulnerability.reference && (
                <div>
                  <strong className="text-cyber-blue">Reference:</strong>{" "}
                  <a
                    href={vulnerability.reference}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-cyber-blue hover:underline"
                  >
                    {vulnerability.reference}
                  </a>
                </div>
              )}
            </>
          )}
          {type === "trivy" && (
            <>
              {vulnerability.installed_version && (
                <div>
                  <strong className="text-cyber-blue">
                    Installed Version:
                  </strong>{" "}
                  {vulnerability.installed_version}
                </div>
              )}
              {vulnerability.fixed_version && (
                <div>
                  <strong className="text-cyber-blue">Fixed Version:</strong>{" "}
                  {vulnerability.fixed_version}
                </div>
              )}
              {vulnerability.cvss && (
                <div>
                  <strong className="text-cyber-blue">CVSS Score:</strong>{" "}
                  {vulnerability.cvss.v3?.score ||
                    vulnerability.cvss.v2?.score ||
                    "N/A"}
                </div>
              )}
              {vulnerability.references &&
                vulnerability.references.length > 0 && (
                  <div>
                    <strong className="text-cyber-blue">References:</strong>
                    <ul className="list-disc list-inside mt-1">
                      {vulnerability.references.slice(0, 3).map((ref, idx) => (
                        <li key={idx}>
                          <a
                            href={ref}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="text-cyber-blue hover:underline text-sm"
                          >
                            {ref}
                          </a>
                        </li>
                      ))}
                    </ul>
                  </div>
                )}
            </>
          )}
        </motion.div>
      )}
    </motion.div>
  );
};

export default VulnerabilityCard;
